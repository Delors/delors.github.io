<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="version" content="LD2 0.1" />
<meta content="Michael Eichberg" name="author" />
<meta content="&quot;Java&quot;, &quot;Concurrency&quot;" name="keywords" />
<meta content="Nebenläufigkeit in Java" lang="de" name="description" xml:lang="de" />
<meta content="Concurrency in Java" lang="en" name="description" xml:lang="en" />
<meta content="lecture-ds-nebenlaeufigkeit" name="id" />
<meta content="last-viewed" name="first-slide" />
<title>Nebenläufigkeit (Concurrency) &lt;br&gt; (in Java)</title>
<link rel="stylesheet" href="../LectureDoc2/normalize.css" type="text/css" />
<style type="text/css">

/* Minimal style sheet for the HTML output of Docutils.                    */
/*                                                                         */
/* :Author: Günter Milde, based on html4css1.css by David Goodger          */
/* :Id: $Id: minimal.css 9079 2022-06-19 14:00:56Z milde $                                                               */
/* :Copyright: © 2015, 2021 Günter Milde.                                  */
/* :License: Released under the terms of the `2-Clause BSD license`_,      */
/*    in short:                                                            */
/*                                                                         */
/*    Copying and distribution of this file, with or without modification, */
/*    are permitted in any medium without royalty provided the copyright   */
/*    notice and this notice are preserved.                                */
/*                                                                         */
/*    This file is offered as-is, without any warranty.                    */
/*                                                                         */
/* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause     */

/* This CSS3 stylesheet defines rules for Docutils elements without        */
/* HTML equivalent. It is required to make the document semantics visible. */
/*                                                                         */
/* .. _validates: http://jigsaw.w3.org/css-validator/validator$link        */

/* titles */
p.topic-title,
p.admonition-title,
p.system-message-title {
  font-weight: bold;
}
p.sidebar-title,
p.rubric {
  font-weight: bold;
  font-size: larger;
}
p.rubric {
  color: maroon;
}
p.subtitle,
p.section-subtitle,
p.sidebar-subtitle {
  font-weight: bold;
  margin-top: -0.5em;
}
h1 + p.subtitle {
  font-size: 1.6em;
}
a.toc-backref {
  color: inherit;
  text-decoration: none;
}

/* Warnings, Errors */
.system-messages h2,
.system-message-title,
span.problematic {
  color: red;
}

/* Inline Literals */
.docutils.literal {
  font-family: monospace;
  white-space: pre-wrap;
}
/* do not wrap at hyphens and similar: */
.literal > span.pre { white-space: nowrap; }

/* Lists */

/* compact and simple lists: no margin between items */
.simple  li, .simple  ul, .simple  ol,
.compact li, .compact ul, .compact ol,
.simple  > li p, dl.simple  > dd,
.compact > li p, dl.compact > dd {
  margin-top: 0;
  margin-bottom: 0;
}
/* Nested Paragraphs */
p:first-child { margin-top: 0; }
p:last-child { margin-bottom: 0; }
details > p:last-child { margin-bottom: 1em; }

/* Table of Contents */
.contents ul.auto-toc { /* section numbers present */
  list-style-type: none;
}

/* Enumerated Lists */
ol.arabic     { list-style: decimal }
ol.loweralpha { list-style: lower-alpha }
ol.upperalpha { list-style: upper-alpha }
ol.lowerroman { list-style: lower-roman }
ol.upperroman { list-style: upper-roman }

/* Definition Lists and Derivatives */
dt .classifier { font-style: italic }
dt .classifier:before {
  font-style: normal;
  margin: 0.5em;
  content: ":";
}
/* Field Lists and similar */
/* bold field name, content starts on the same line */
dl.field-list,
dl.option-list,
dl.docinfo {
  display: flow-root;
}
dl.field-list > dt,
dl.option-list > dt,
dl.docinfo > dt {
  font-weight: bold;
  clear: left;
  float: left;
  margin: 0;
  padding: 0;
  padding-right: 0.2em;
}
/* Offset for field content (corresponds to the --field-name-limit option) */
dl.field-list > dd,
dl.option-list > dd,
dl.docinfo > dd {
  margin-left:  9em; /* ca. 14 chars in the test examples, fit all Docinfo fields */
}
/* start nested lists on new line */
dd > dl:first-child,
dd > ul:first-child,
dd > ol:first-child {
  clear: left;
}
/* start field-body on a new line after long field names */
dl.field-list > dd > *:first-child,
dl.option-list > dd > *:first-child
{
  display: inline-block;
  width: 100%;
  margin: 0;
}

/* Bibliographic Fields (docinfo) */
dl.docinfo pre.address {
  font: inherit;
  margin: 0.5em 0;
}
dl.docinfo > dd.authors > p { margin: 0; }

/* Option Lists */
dl.option-list > dt { font-weight: normal; }
span.option { white-space: nowrap; }

/* Footnotes and Citations  */

.footnote, .citation { margin: 1em 0; } /* default paragraph skip (Firefox) */
/* hanging indent */
.citation { padding-left: 2em; }
.footnote { padding-left: 1.7em; }
.footnote.superscript { padding-left: 1.0em; }
.citation > .label { margin-left: -2em; }
.footnote > .label { margin-left: -1.7em; }
.footnote.superscript > .label { margin-left: -1.0em; }

.footnote > .label + *,
.citation > .label + * {
  display: inline-block;
  margin-top: 0;
  vertical-align: top;
}
.footnote > .backrefs + *,
.citation > .backrefs + * {
  margin-top: 0;
}
.footnote > .label + p, .footnote > .backrefs + p,
.citation > .label + p, .citation > .backrefs + p {
  display: inline;
  vertical-align: inherit;
}

.backrefs { user-select: none; }
.backrefs > a { font-style: italic; }

/* superscript footnotes */
a[role="doc-noteref"].superscript,
.footnote.superscript > .label,
.footnote.superscript > .backrefs {
  vertical-align: super;
  font-size: smaller;
  line-height: 1;
}
a[role="doc-noteref"].superscript > .fn-bracket,
.footnote.superscript > .label > .fn-bracket {
  /* hide brackets in display but leave for copy/paste */
  display: inline-block;
  width: 0;
  overflow: hidden;
}
[role="doc-noteref"].superscript + [role="doc-noteref"].superscript {
  padding-left: 0.15em; /* separate consecutive footnote references */
  /* TODO: unfortunately, "+" also selects with text between the references. */
}

/* Alignment */
.align-left   {
  text-align: left;
  margin-right: auto;
}
.align-center {
  text-align: center;
  margin-left: auto;
  margin-right: auto;
}
.align-right  {
  text-align: right;
  margin-left: auto;
}
.align-top    { vertical-align: top; }
.align-middle { vertical-align: middle; }
.align-bottom { vertical-align: bottom; }

/* reset inner alignment in figures and tables */
figure.align-left, figure.align-right,
table.align-left, table.align-center, table.align-right {
  text-align: inherit;
}

/* Text Blocks */
.topic { margin: 1em 2em; }
.sidebar,
.admonition,
.system-message {
  margin: 1em 2em;
  border: thin solid;
  padding: 0.5em 1em;
}
div.line-block { display: block; }
div.line-block div.line-block, pre { margin-left: 2em; }

/* Code line numbers: dropped when copying text from the page */
pre.code .ln { display: none; }
pre.code code:before {
  content: attr(data-lineno); /* …, none) fallback not supported by any browser */
  color: gray;
}

/* Tables */
table {
  border-collapse: collapse;
}
td, th {
  border: thin solid silver;
  padding: 0 1ex;
}
.borderless td, .borderless th {
  border: 0;
  padding: 0;
  padding-right: 0.5em /* separate table cells */
}

table > caption {
  text-align: left;
  margin-top: 0.2em;
  margin-bottom: 0.2em;
}
table.captionbelow {
  caption-side: bottom;
}

/* Document Header and Footer */
header { border-bottom: 1px solid black; }
footer { border-top: 1px solid black; }

/* Images are block-level by default in Docutils */
/* New HTML5 block elements: set display for older browsers */
img, header, footer, main, aside, nav, section, figure, video, details {
  display: block;
}
/* inline images */
p img, p video, figure img, figure video {
  display: inline;
}

</style>
<style type="text/css">

/* CSS31_ style sheet for the output of Docutils HTML writers.             */
/* Rules for easy reading and pre-defined style variants.                  */
/*                                                                         */
/* :Author: Günter Milde, based on html4css1.css by David Goodger          */
/* :Id: $Id: plain.css 9338 2023-04-08 21:08:47Z milde $                                                               */
/* :Copyright: © 2015 Günter Milde.                                        */
/* :License: Released under the terms of the `2-Clause BSD license`_,      */
/*    in short:                                                            */
/*                                                                         */
/*    Copying and distribution of this file, with or without modification, */
/*    are permitted in any medium without royalty provided the copyright   */
/*    notice and this notice are preserved.                                */
/*                                                                         */
/*    This file is offered as-is, without any warranty.                    */
/*                                                                         */
/* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause     */
/* .. _CSS3: https://www.w3.org/Style/CSS/                                 */


/* Document Structure */
/* ****************** */

/* "page layout" */
body {
  margin: 0;
  background-color: #dbdbdb;
  --field-indent: 9em; /* default indent of fields in field lists */
}
main, footer, header {
  line-height:1.6;
  /* avoid long lines --> better reading */
  /* optimum is 45…75 characters/line <http://webtypography.net/2.1.2> */
  /* OTOH: lines should not be too short because of missing hyphenation, */
  max-width: 50rem;
  padding: 1px 2%; /* 1px on top avoids grey bar above title (mozilla) */
  margin: auto;
}
main {
  counter-reset: table figure;
  background-color: white;
}
footer, header {
  font-size: smaller;
  padding: 0.5em 2%;
  border: none;
}

/* Table of Contents */
ul.auto-toc > li > p {
  padding-left: 1em;
  text-indent: -1em;
}
nav.contents ul {
  padding-left: 1em;
}
main > nav.contents ul ul ul ul:not(.auto-toc) {
  list-style-type: '\2B29\ ';
}
main > nav.contents ul ul ul ul ul:not(.auto-toc) {
  list-style-type: '\2B1D\ ';
}

/* Transitions */
hr.docutils {
  width: 80%;
  margin-top: 1em;
  margin-bottom: 1em;
  clear: both;
}

/* Paragraphs */

/* vertical space (parskip) */
p, ol, ul, dl, li,
div.line-block,
.footnote, .citation,
div > math,
table {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

h1, h2, h3, h4, h5, h6,
dd, details > p:last-child {
  margin-bottom: 0.5em;
}

/* Lists */
/* ===== */

/* Definition Lists */
/* Indent lists nested in definition lists */
dd > ul:only-child, dd > ol:only-child { padding-left: 1em; }

/* Description Lists */
/* styled like in most dictionaries, encyclopedias etc. */
dl.description {
  display: flow-root;
}
dl.description > dt {
  font-weight: bold;
  clear: left;
  float: left;
  margin: 0;
  padding: 0;
  padding-right: 0.3em;
}
dl.description > dd:after {
  display: table;
  content: "";
  clear: left; /* clearfix for empty descriptions */
}

/* Field Lists */

dl.field-list > dd,
dl.docinfo > dd {
  margin-left: var(--field-indent); /* adapted in media queries or HTML */
}

/* example for custom field-name width */
dl.field-list.narrow > dd {
  --field-indent: 5em;
}
/* run-in: start field-body on same line after long field names */
dl.field-list.run-in > dd p {
  display: block;
}

/* Bibliographic Fields */

/* generally, bibliographic fields use dl.docinfo */
/* but dedication and abstract are placed into divs */
div.abstract p.topic-title {
  text-align: center;
}
div.dedication {
  margin: 2em 5em;
  text-align: center;
  font-style: italic;
}
div.dedication p.topic-title {
  font-style: normal;
}

/* disclosures */
details { padding-left: 1em; }
summary { margin-left: -1em; }

/* Text Blocks */
/* =========== */

/* Literal Blocks */
pre.literal-block, pre.doctest-block,
pre.math, pre.code {
  font-family: monospace;
}

/* Block Quotes and Topics */
bockquote { margin: 1em 2em; }
blockquote p.attribution,
.topic p.attribution {
  text-align: right;
  margin-left: 20%;
}

/* Tables */
/* ====== */

/* th { vertical-align: bottom; } */

table tr { text-align: left; }

/* "booktabs" style (no vertical lines) */
table.booktabs {
  border: 0;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.booktabs * {
  border: 0;
}
table.booktabs th {
  border-bottom: thin solid;
}

/* numbered tables (counter defined in div.document) */
table.numbered > caption:before {
  counter-increment: table;
  content: "Table " counter(table) ": ";
  font-weight: bold;
}

/* Explicit Markup Blocks */
/* ====================== */

/* Footnotes and Citations */
/* ----------------------- */

/* line on the left */
.footnote-list {
  border-left: solid thin;
  padding-left: 0.25em;
}

/* Directives */
/* ---------- */

/* Body Elements */
/* ~~~~~~~~~~~~~ */

/* Images and Figures */

/* let content flow to the side of aligned images and figures */
figure.align-left,
img.align-left,
video.align-left,
object.align-left {
  clear: left;
  float: left;
  margin-right: 1em;
}
figure.align-right,
img.align-right,
video.align-right,
object.align-right {
  clear: right;
  float: right;
  margin-left: 1em;
}
/* Stop floating sidebars, images and figures */
h1, h2, h3, h4, footer, header { clear: both; }

/* Numbered figures */
figure.numbered > figcaption > p:before {
  counter-increment: figure;
  content: "Figure " counter(figure) ": ";
  font-weight: bold;
}

/* Admonitions and System Messages */
.caution p.admonition-title,
.attention p.admonition-title,
.danger p.admonition-title,
.error p.admonition-title,
.warning p.admonition-title,
div.error {
  color: red;
}

/* Sidebar */
/* Move right. In a layout with fixed margins, */
/* it can be moved into the margin.            */
aside.sidebar {
  width: 30%;
  max-width: 26em;
  float: right;
  clear: right;
  margin-left: 1em;
  margin-right: -1%;
  background-color: #fffffa;
}


/* Code */
pre.code { padding: 0.7ex }
pre.code, code { background-color: #eeeeee }
/* basic highlighting: for a complete scheme, see */
/* https://docutils.sourceforge.io/sandbox/stylesheets/ */
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

/* Math */
/* for math-output=MathML (for math-output=HTML, see math.css) */
math .boldsymbol {
  font-weight: bold;
}
mstyle.mathscr, mi.mathscr {
  font-family: STIX, XITSMathJax_Script, rsfs10,
               "Asana Math", Garamond, cursive;
}

/* Epigraph           */
/* Highlights         */
/* Pull-Quote         */
/* Compound Paragraph */
/* Container          */

/* Inline Markup */
/* ============= */

sup, sub { line-height: 0.8; } /* do not add leading for lines with sup/sub */

/* Inline Literals                                          */
/* possible values: normal, nowrap, pre, pre-wrap, pre-line */
/*   span.docutils.literal { white-space: pre-wrap; }       */

/* Hyperlink References */
a { text-decoration: none; }

/* External Targets       */
/*   span.target.external */
/* Internal Targets       */
/*   span.target.internal */
/* Footnote References    */
/*   a[role="doc-noteref"] */
/* Citation References    */
/*   a.citation-reference */

</style>
    <script src="../LectureDoc2/ld-animations.js" type="text/javascript"></script>
    <script src="../LectureDoc2/ld-help.js" type="text/javascript"></script>
    <script src="../LectureDoc2/ld-core.js" type="text/javascript"></script>
    <link rel="stylesheet" href="../LectureDoc2/ld.css" type="text/css" />
    <link rel="stylesheet" href="../LectureDoc2/themes/DHBW/theme.css" type="text/css" />
</head>
<body>
<div class="ld-slide" id="slide0">
<h1 class="title">Nebenläufigkeit (<span class="eng">Concurrency</span>) <span class="raw-html"><br></span> (in Java)</h1>

<div class="line-above padding-bottom-1em docutils container">
<dl class="field-list simple">
<dt>Dozent<span class="colon">:</span></dt>
<dd><p><a class="reference external" href="https://delors.github.io/cv/folien.rst.html">Prof. Dr. Michael Eichberg</a></p>
</dd>
<dt>Kontakt<span class="colon">:</span></dt>
<dd><p><a class="reference external" href="mailto:michael.eichberg&#64;dhbw-mannheim.de">michael.eichberg&#64;dhbw-mannheim.de</a></p>
</dd>
<dt>Version<span class="colon">:</span></dt>
<dd><p>2024-02-26</p>
</dd>
</dl>
</div>
<div class="small line-above padding-bottom-1em docutils container">
<dl class="field-list simple">
<dt>Folien<span class="colon">:</span></dt>
<dd><p><a class="reference external" href="https://delors.github.io/ds-nebenlaeufigkeit-in-java/folien.rst.html">https://delors.github.io/ds-nebenlaeufigkeit-in-java/folien.rst.html</a> <span class="raw-html"><br></span>
<a class="reference external" href="https://delors.github.io/ds-nebenlaeufigkeit-in-java/folien.rst.html.pdf">https://delors.github.io/ds-nebenlaeufigkeit-in-java/folien.rst.html.pdf</a></p>
</dd>
<dt>Fehler auf Folien melden<span class="colon">:</span></dt>
<dd><p><a class="reference external" href="https://github.com/Delors/delors.github.io">https://github.com/Delors/delors.github.io</a>
<span class="raw-html"><br></span>
<a class="reference external" href="https://github.com/Delors/delors.github.io/issues">https://github.com/Delors/delors.github.io/issues</a></p>
</dd>
</dl>
</div>
</div>
<div class="no-title center-child-elements ld-slide" id="nebenlaufigkeit">
<h2>Nebenläufigkeit</h2>
<p>Ein gutes Verständnis von nebenläufiger Programmierung ist für die Entwicklung von verteilten Anwendungen unerlässlich, da Server immer mehrere Anfragen gleichzeitig bearbeiten.</p>
</div><div class="ld-slide" id="prozesse-vs-threads">
<h2>Prozesse vs. Threads</h2>
<img alt="Prozesse vs. Threads" class="align-center" src="images/threads/threads.svg" style="width: 100%;" />
<div class="supplemental">
<ul class="simple">
<li><p>Prozesse sind voneinander isoliert und können nur über explizite Mechanismen miteinander kommunizieren; Prozesse teilen sich nicht den selben Adressraum.</p></li>
<li><p>Alle Threads eines Prozesses teilen sich den selben Adressraum. <em>Native Threads</em> sind vom Betriebssystem unterstützte Threads, die direkt vom Betriebssystem verwaltet werden. Standard Java Threads sind <em>Native Threads</em>.</p></li>
<li><p><em>Fibres</em> (auch <em>Coroutines</em>) nutzen immer kooperatives Multitasking. D.h. ein Fibre gibt die Kontrolle an eine andere Fibre explizit ab. (Früher auch als <em>Green Threads</em> bezeichnet.) Diese sind für das Betriebssystem unsichtbar.</p></li>
</ul>
</div></div><div class="ld-slide" id="kommunikation-und-synchronisation-mit-hilfe-von-monitoren">
<h2>Kommunikation und Synchronisation mit Hilfe von <em>Monitoren</em></h2>
<p>Ein <em>Monitor</em> ist ein Objekt, bei dem die Methoden im wechselseitigen Ausschluss (engl. <em>mutual exclusion</em>) ausgeführt werden.</p>
<div class="two-columns docutils container">
<img alt="Monitor" src="images/threads/monitor.svg" style="height: 600px;" />
<div class="docutils container">
<p>Bedingungs-Synchronisation</p>
<ul class="simple">
<li><p>drückt eine Bedingung für die Reihenfolge der Ausführung von Operationen aus,</p></li>
<li><p>z. B. können Daten erst dann aus einem Puffer entfernt werden, wenn Daten in den Puffer eingegeben wurden.</p></li>
<li><p>Java unterstützt pro Monitor nur eine (anonyme) Bedingungs-Variable, mit den klassischen Methoden <span class="docutils literal">wait</span> und <span class="docutils literal">notify</span> bzw. <span class="docutils literal">notifyAll</span>.</p></li>
</ul>
</div>
</div>
<div class="supplemental">
<aside class="admonition warning">
<p class="admonition-title">Warnung</p>
<p>In Java findet der wechselseitige Ausschluss nur zwischen solchen Methoden statt, die explizit als <span class="docutils literal">synchronized</span> deklariert wurden.</p>
</aside>
<p><em>Monitore</em> sind nur ein Model (Alternativen: <em>Semaphores</em>, <em>Message Passing</em>), dass die Kommunikation und Synchronisation von Threads ermöglicht. Es ist das Standardmodel in Java und wird von der Java Virtual Machine (JVM) unterstützt.</p>
</div></div><div class="ld-slide" id="kommunikation-zwischen-threads-mit-hilfe-von-monitoren">
<h2>Kommunikation zwischen Threads mit Hilfe von Monitoren</h2>
<ul class="simple">
<li><p>Durch Lesen und Schreiben von Daten, die in gemeinsamen Objekten gekapselt sind, die durch Monitore geschützt werden.</p></li>
<li><p>Jedes Objekt ist implizit von der Klasse <span class="docutils literal">Object</span> abgeleitet, welche eine gegenseitige Ausschlusssperre definiert.</p></li>
<li><p>Methoden in einer Klasse können als <span class="docutils literal">synchronized</span> gekennzeichnet werden. Die Methode wird erst dann ausgeführt, wenn die Sperre vorliegt. Bis dahin wird gewartet. Dieser Prozess geschieht automatisch.</p></li>
<li><p>Die Sperre kann auch über eine <span class="docutils literal">synchronized</span> Anweisung erworben werden, die das Objekt benennt.</p></li>
<li><p>Ein Thread kann auf eine einzelne (anonyme) Bedingungsvariable warten und diese benachrichtigen</p></li>
</ul>
</div><div class="ld-slide" id="nebenfaufigkeit-in-java">
<h2>Nebenfäufigkeit in Java</h2>
<img alt="java.lang.Thread" class="align-center" src="images/threads/java-threads.svg" style="height: 900px;" />
<div class="supplemental">
<ul>
<li><p>Threads werden in Java über die vordefinierte Klasse java.lang.Thread bereitgestellt.</p></li>
<li><p>Alternativ kann das Interface:</p>
<p><span class="docutils literal">public interface Runnable { void <span class="pre">run();</span> }</span></p>
<p>implementiert werden und an ein Thread-Objekt übergeben werden.</p>
</li>
<li><p>Threads beginnen ihre Ausführung erst, wenn die <span class="docutils literal">start</span>-Methode in der Thread-Klasse aufgerufen wird. Die <span class="docutils literal">Thread.start</span>-Methode ruft die <span class="docutils literal">run</span>-Methode auf. Ein Aufruf der <span class="docutils literal">run</span>-Methode direkt führt nicht zu einer parallelen Ausführung.</p></li>
<li><p>Der aktuelle Thread kann mittels der statischen Methode <span class="docutils literal">Thread.currentThread()</span> ermittelt werden.</p></li>
<li><p>Ein Thread wird beendet wenn die Ausführung seiner Run-Methode entweder normal oder als Ergebnis einer unbehandelten Ausnahme endet.</p></li>
<li><p>Java unterscheidet <em>User</em>-Threads und <em>Daemon</em>-Threads.</p>
<p><em>Daemon-Threads</em> sind Threads, die allgemeine Dienste bereitstellen und normalerweise nie beendet werden.</p>
<p>Wenn alle Benutzer-Threads beendet sind, werden die Daemon-Threads von der JVM beendet, und das Hauptprogramm wird beendet.</p>
<p>Die Methode <span class="docutils literal">setDaemon</span> muss aufgerufen werden, bevor der Thread gestartet wird.</p>
</li>
</ul>
</div></div><div class="ld-slide" id="inter-thread-kommunikation-bzw-koordination">
<h2>Inter-Thread-Kommunikation bzw. Koordination</h2>
<ul class="simple">
<li><p>Ein Thread kann (mit oder ohne Zeitüberschreitung) auf die Beendigung eines anderen Threads (des Ziels) warten, indem er die <span class="docutils literal">join</span>-Methode für das Thread-Objekt des Ziels aufruft.</p></li>
<li><p>Mit der Methode <span class="docutils literal">isAlive</span> kann ein Thread feststellen, ob der Ziel-Thread beendet wurde.</p></li>
</ul>
</div><div class="ld-slide" id="java-thread-states">
<h2>Java Thread States</h2>
<img alt="Java Thread States" class="align-center" src="images/threads/java-thread-states.svg" style="height: 950px;" />
</div><div class="ld-slide" id="synchronized-methoden-und-synchronized-blocke">
<h2><span class="docutils literal">synchronized</span>-Methoden und <span class="docutils literal">synchronized</span>-Blöcke</h2>
<ul class="simple">
<li><p>Jedem Objekt ist eine gegenseitige Ausschlusssperre zugeordnet. Auf die Sperre kann von der Anwendung nicht explizit zugegriffen werden. Dies geschieht implizit, wenn:</p>
<ul>
<li><p>eine Methode den Methodenmodifikator <span class="docutils literal">synchronized</span> verwendet</p></li>
<li><p>Blocksynchronisierung mit dem Schlüsselwort <span class="docutils literal">synchronized</span> verwendet wird</p></li>
</ul>
</li>
<li><p>Wenn eine Methode als synchronisiert gekennzeichnet ist, kann der Zugriff auf die Methode nur erfolgen, wenn das System die Sperre erhalten hat.</p></li>
<li><p>Daher haben synchronisierte Methoden einen sich gegenseitig ausschließenden Zugriff auf die vom Objekt gekapselten Daten, <span class="dhbw-red">wenn auf diese Daten nur von anderen synchronisierten Methoden zugegriffen wird</span>.</p></li>
<li><p>Nicht-synchronisierte Methoden benötigen keine Sperre und können daher <em>jederzeit</em> aufgerufen werden.</p></li>
</ul>
</div><div class="ld-slide" id="beispiel-synchronisierte-methode">
<h2>Beispiel: Synchronisierte Methode</h2>
<div class="stack tiny">
<div class="layer">
<pre class="code Java literal-block"><code><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">class</span> <span class="name class">SynchronizedCounter</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">

  </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">count</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal number integer">0</span><span class="punctuation">;</span><span class="whitespace">

  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">synchronized</span><span class="whitespace"> </span><span class="keyword type">void</span><span class="whitespace"> </span><span class="name function">increment</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="name">count</span><span class="operator">++</span><span class="punctuation">;</span><span class="whitespace">
  </span><span class="punctuation">}</span><span class="whitespace">

  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">synchronized</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name function">getCount</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="keyword">return</span><span class="whitespace"> </span><span class="name">count</span><span class="punctuation">;</span><span class="whitespace">
  </span><span class="punctuation">}</span><span class="whitespace">
</span><span class="punctuation">}</span></code></pre>
</div><div class="layer incremental">
<pre class="code Java literal-block"><code><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">class</span> <span class="name class">SharedLong</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">

  </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword type">long</span><span class="whitespace"> </span><span class="name">theData</span><span class="punctuation">;</span><span class="whitespace"> </span><span class="comment single">// reading and writing longs is not atomic</span><span class="whitespace">

  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="name function">SharedLong</span><span class="punctuation">(</span><span class="keyword type">long</span><span class="whitespace"> </span><span class="name">initialValue</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="name">theData</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">initialValue</span><span class="punctuation">;</span><span class="whitespace">
  </span><span class="punctuation">}</span><span class="whitespace">

  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">synchronized</span><span class="whitespace"> </span><span class="keyword type">long</span><span class="whitespace"> </span><span class="name function">read</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace"> </span><span class="keyword">return</span><span class="whitespace"> </span><span class="name">theData</span><span class="punctuation">;</span><span class="whitespace"> </span><span class="punctuation">}</span><span class="whitespace">

  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">synchronized</span><span class="whitespace"> </span><span class="keyword type">void</span><span class="whitespace"> </span><span class="name function">write</span><span class="punctuation">(</span><span class="keyword type">long</span><span class="whitespace"> </span><span class="name">newValue</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace"> </span><span class="name">theData</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">newValue</span><span class="punctuation">;</span><span class="whitespace"> </span><span class="punctuation">}</span><span class="whitespace">

  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">synchronized</span><span class="whitespace"> </span><span class="keyword type">void</span><span class="whitespace"> </span><span class="name function">incrementBy</span><span class="punctuation">(</span><span class="keyword type">long</span><span class="whitespace"> </span><span class="name">by</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="name">theData</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">theData</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="name">by</span><span class="punctuation">;</span><span class="whitespace">
  </span><span class="punctuation">}</span><span class="whitespace">
</span><span class="punctuation">}</span><span class="whitespace">

</span><span class="name">SharedLong</span><span class="whitespace"> </span><span class="name">myData</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">SharedLong</span><span class="punctuation">(</span><span class="literal number integer">42</span><span class="punctuation">);</span></code></pre>
</div><div class="layer incremental">
<pre class="code Java literal-block"><code><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">class</span> <span class="name class">SynchronizedCounter</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">

  </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">count</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal number integer">0</span><span class="punctuation">;</span><span class="whitespace">

  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword type">void</span><span class="whitespace"> </span><span class="name function">increment</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="keyword declaration">synchronized</span><span class="punctuation">(</span><span class="keyword">this</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
      </span><span class="name">count</span><span class="operator">++</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace">
  </span><span class="punctuation">}</span><span class="whitespace">

  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name function">getCount</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="keyword declaration">synchronized</span><span class="punctuation">(</span><span class="keyword">this</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
      </span><span class="keyword">return</span><span class="whitespace"> </span><span class="name">count</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace">
  </span><span class="punctuation">}</span><span class="whitespace">
</span><span class="punctuation">}</span></code></pre>
</div></div><div class="supplemental">
<aside class="admonition warning">
<p class="admonition-title">Warnung</p>
<p>Wenn <span class="docutils literal">synchronized</span> in seiner ganzen Allgemeinheit verwendet wird, kann er einen der Vorteile von klassischen Monitoren untergraben: Die Kapselung von Synchronisationseinschränkungen, die mit einem Objekt verbunden sind, an einer einzigen Stelle im Programm!</p>
</aside>
<p>Dies liegt daran, dass es nicht möglich ist, die mit einem bestimmten Objekt verbundene Synchronisation zu verstehen, indem man sich nur das Objekt selbst ansieht. Andere Objekte können bgzl. des Objekts eine <span class="docutils literal">synchronized</span>-Block verwenden.</p>
</div></div><div class="ld-slide" id="komplexe-ruckgabewerte">
<h2>Komplexe Rückgabewerte</h2>
<pre class="code Java tiny literal-block"><code><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">class</span> <span class="name class">SharedCoordinate</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">

  </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">x</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="name">y</span><span class="punctuation">;</span><span class="whitespace">

  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="name function">SharedCoordinate</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">initX</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">initY</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="keyword">this</span><span class="punctuation">.</span><span class="name attribute">x</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">initX</span><span class="punctuation">;</span><span class="whitespace"> </span><span class="keyword">this</span><span class="punctuation">.</span><span class="name attribute">y</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">initY</span><span class="punctuation">;</span><span class="whitespace">
  </span><span class="punctuation">}</span><span class="whitespace">

  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">synchronized</span><span class="whitespace"> </span><span class="keyword type">void</span><span class="whitespace"> </span><span class="name function">write</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">newX</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">newY</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="keyword">this</span><span class="punctuation">.</span><span class="name attribute">x</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">newX</span><span class="punctuation">;</span><span class="whitespace"> </span><span class="keyword">this</span><span class="punctuation">.</span><span class="name attribute">y</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">newY</span><span class="punctuation">;</span><span class="whitespace">
  </span><span class="punctuation">}</span><span class="whitespace">

  </span><span class="comment multiline">/* ⚠️ */</span><span class="whitespace"> </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="comment multiline">/* synchronized irrelevant */</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name function">readX</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace"> </span><span class="keyword">return</span><span class="whitespace"> </span><span class="name">x</span><span class="punctuation">;</span><span class="whitespace"> </span><span class="punctuation">}</span><span class="whitespace"> </span><span class="comment multiline">/* ⚠️ */</span><span class="whitespace">
  </span><span class="comment multiline">/* ⚠️ */</span><span class="whitespace"> </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="comment multiline">/* synchronized irrelevant */</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name function">readY</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace"> </span><span class="keyword">return</span><span class="whitespace"> </span><span class="name">y</span><span class="punctuation">;</span><span class="whitespace"> </span><span class="punctuation">}</span><span class="whitespace"> </span><span class="comment multiline">/* ⚠️ */</span><span class="whitespace">

  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">synchronized</span><span class="whitespace"> </span><span class="name">SharedCoordinate</span><span class="whitespace"> </span><span class="name function">read</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="keyword">return</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">SharedCoordinate</span><span class="punctuation">(</span><span class="name">x</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="name">y</span><span class="punctuation">);</span><span class="whitespace">
  </span><span class="punctuation">}</span><span class="whitespace">
</span><span class="punctuation">}</span></code></pre>
<div class="supplemental">
<p>Die beiden Methoden: <span class="docutils literal">readX</span> und <span class="docutils literal">readY</span> sind nicht synchronisiert, da das Lesen von <span class="docutils literal">int</span>-Werten atomar ist. Allerdings erlauben sie das Auslesen eines inkonsistenten Zustands! Es ist denkbar, dass direkt nach einem <span class="docutils literal">readX</span> der entsprechende Thread unterbrochen wird und ein anderer Thread die Werte von <span class="docutils literal">x</span> und <span class="docutils literal">y</span> verändert. Wird dann der ursprüngliche Thread fortgesetzt, und ruft <span class="docutils literal">readY</span> auf, so erhält er den neuen Werte von <span class="docutils literal">y</span> und hat somit ein paar <span class="docutils literal">x</span>, <span class="docutils literal">y</span> vorliegen, dass in dieser Form nie existiert hat.</p>
<p>Ein konsistenter Zustand kann nur durch die Methode <span class="docutils literal">read</span> ermittelt werden, die die Werte von <span class="docutils literal">x</span> und <span class="docutils literal">y</span> in einem Schritt ausliest und als Paar zurückgibt.</p>
<p>Kann sichergestellt werden, dass ein auslesender Thread die Instanz in einem <span class="docutils literal">synchronized</span> Block benennt, dann kann die Auslesung eines konsistenten Zustands auch bei mehreren Methodenaufrufen hintereinander sichergestellt werden.</p>
<pre class="code Java literal-block"><code><span class="name">SharedCoordinate</span><span class="whitespace"> </span><span class="name">point</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">SharedCoordinate</span><span class="punctuation">(</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">);</span><span class="whitespace">
</span><span class="keyword declaration">synchronized</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">point1</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
  </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">x</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">point1</span><span class="punctuation">.</span><span class="name attribute">readX</span><span class="punctuation">();</span><span class="whitespace">
  </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">y</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">point1</span><span class="punctuation">.</span><span class="name attribute">readY</span><span class="punctuation">();</span><span class="whitespace">
</span><span class="punctuation">}</span><span class="whitespace">
</span><span class="comment single">// do something with x and y</span></code></pre>
<p>Diese <span class="ger-quote">Lösung</span> muss jedoch als sehr kritisch betrachtet werden, da die Wahrscheinlichkeit von Programmierfehlern <em>sehr hoch</em> ist und es dann entweder zur <em>Race Conditions</em> oder zu <em>Deadlocks</em> kommen kann.scheme</p>
</div></div><div class="ld-slide" id="bedingte-synchronisation">
<h2>Bedingte Synchronisation</h2>
<blockquote>
<p>Zum Zwecke der bedingten Synchronisation können in Java die Methoden <span class="docutils literal">wait</span>, <span class="docutils literal">notify</span> und <span class="docutils literal">notifyAll</span> verwendet werden.  Diese Methoden erlauben es auf bestimmte Bedingungen zu warten und andere Threads zu benachrichtigen, wenn sich die Bedingung geändert hat.</p>
</blockquote>
<div class="stack incremental footnotesize margin-top-1em">
<div class="layer">
<ul class="simple">
<li><p>Diese Methoden können nur innerhalb von Methoden verwendet werden, die die Objektsperre halten; andernfalls wird eine <span class="docutils literal">IllegalMonitorStateException</span> ausgelöst.</p></li>
</ul>
</div><div class="layer incremental">
<ul class="simple">
<li><p>Die <span class="docutils literal">wait</span>-Methode blockiert immer den aufrufenden Thread und gibt die mit dem Objekt verbundene Sperre frei.</p></li>
</ul>
</div><div class="layer incremental">
<ul>
<li><p>Die <span class="docutils literal">notify</span>-Methode weckt <em>einen</em> wartenden Thread auf. Welcher Thread aufgeweckt wird, ist nicht spezifiziert.</p>
<p><span class="docutils literal">notify</span> gibt die Sperre nicht frei; daher muss der aufgeweckte Thread warten, bis er die Sperre erhalten kann, bevor er fortfahren kann.</p>
</li>
<li><p>Um alle wartenden Threads aufzuwecken, muss die Methode <span class="docutils literal">notifyAll</span> verwendet werden.</p>
<p>Warten die Threads aufgrund unterschiedlicher Bedingungen so ist immer <span class="docutils literal">notifyAll</span> zu verwenden.</p>
</li>
<li><p>Wenn kein Thread wartet, dann haben <span class="docutils literal">notify</span> und <span class="docutils literal">notifyAll</span> keine Wirkung.</p></li>
</ul>
</div><div class="layer incremental">
<aside class="admonition warning">
<p class="admonition-title">Wichtig</p>
<p>Wenn ein Thread aufgeweckt wird, kann er nicht davon ausgehen, dass seine Bedingung erfüllt ist!</p>
<p>Die Bedingung ist immer in einer Schleife zu prüfen und der Thread muss ich ggf. wieder in den Wartezustand versetzen.</p>
</aside>
</div></div></div><div class="smaller ld-slide" id="beispiel-bedingte-synchronisation-mit-condition-variables">
<h2>Beispiel: Bedingte Synchronisation mit <em>Condition Variables</em></h2>
<p>Ein <em>BoundedBuffer</em> hat z. B. traditionell zwei Bedingungsvariablen: <em>BufferNotFull</em> und <em>BufferNotEmpty</em>.</p>
<div class="stack">
<div class="layer">
<p>Wenn ein Thread auf eine Bedingung wartet, kann kein anderer Thread auf die andere Bedingung warten.</p>
<p><span class="minor">Mit den bisher vorstellten Primitiven ist eine direkte Modellierung dieses Szenarios so nicht möglich. Stattdessen müssen immer alle Threads aufgeweckt werden, um sicherzustellen, dass auch der intendierte Thread aufgeweckt wird. Deswegen ist auch das Überprüfen der Bedingung in einer Schleife notwendig.</span></p>
</div><div class="layer incremental tiny">
<pre class="code Java smaller literal-block"><code><span class="whitespace">  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">class</span> <span class="name class">BoundedBuffer</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">buffer</span><span class="operator">[]</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">first</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">last</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">numberInBuffer</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal number integer">0</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">size</span><span class="punctuation">;</span><span class="whitespace">

    </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="name function">BoundedBuffer</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">length</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
      </span><span class="name">size</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">length</span><span class="punctuation">;</span><span class="whitespace">
      </span><span class="name">buffer</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="operator">[</span><span class="name">size</span><span class="operator">]</span><span class="punctuation">;</span><span class="whitespace">
      </span><span class="name">last</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal number integer">0</span><span class="punctuation">;</span><span class="whitespace">
      </span><span class="name">first</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal number integer">0</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="punctuation">};</span><span class="whitespace">
    </span><span class="punctuation">...</span><span class="whitespace">
  </span><span class="punctuation">}</span></code></pre>
</div><div class="layer incremental tiny">
<pre class="code Java smaller literal-block"><code><span class="whitespace">  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">synchronized</span><span class="whitespace"> </span><span class="keyword type">void</span><span class="whitespace"> </span><span class="name function">put</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">item</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword declaration">throws</span><span class="whitespace"> </span><span class="name">InterruptedException</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="keyword">while</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">numberInBuffer</span><span class="whitespace"> </span><span class="operator">==</span><span class="whitespace"> </span><span class="name">size</span><span class="punctuation">)</span><span class="whitespace">
      </span><span class="name">wait</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="name">last</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">last</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal number integer">1</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="operator">%</span><span class="whitespace"> </span><span class="name">size</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="name">numberInBuffer</span><span class="operator">++</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="name">buffer</span><span class="operator">[</span><span class="name">last</span><span class="operator">]</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">item</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="name">notifyAll</span><span class="punctuation">();</span><span class="whitespace">
  </span><span class="punctuation">};</span></code></pre>
</div><div class="layer incremental tiny">
<pre class="code Java smaller literal-block"><code><span class="whitespace">  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">synchronized</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name function">get</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="keyword declaration">throws</span><span class="whitespace"> </span><span class="name">InterruptedException</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="keyword">while</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">numberInBuffer</span><span class="whitespace"> </span><span class="operator">==</span><span class="whitespace"> </span><span class="literal number integer">0</span><span class="punctuation">)</span><span class="whitespace">
      </span><span class="name">wait</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="name">first</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">first</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal number integer">1</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="operator">%</span><span class="whitespace"> </span><span class="name">size</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="name">numberInBuffer</span><span class="operator">--</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="name">notifyAll</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="keyword">return</span><span class="whitespace"> </span><span class="name">buffer</span><span class="operator">[</span><span class="name">first</span><span class="operator">]</span><span class="punctuation">;</span><span class="whitespace">
  </span><span class="punctuation">}</span><span class="whitespace">
</span><span class="punctuation">}</span></code></pre>
</div><div class="layer incremental tiny">
<div class="text-align-center dhbw-red bolder docutils container">
<p>Fehlersituation, die bei der Verwendung von <span class="docutils literal">notify</span> (statt <span class="docutils literal">notifyAll</span>) auftreten könnte.</p>
</div>
<pre class="code Java smaller literal-block"><code><span class="name">BoundedBuffer</span><span class="whitespace"> </span><span class="name">bb</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">BoundedBuffer</span><span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">);</span><span class="whitespace">
</span><span class="name">Thread</span><span class="whitespace"> </span><span class="name">g1</span><span class="punctuation">,</span><span class="name">g2</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">Thread</span><span class="punctuation">(()</span><span class="whitespace"> </span><span class="operator">=&gt;</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace"> </span><span class="name">bb</span><span class="punctuation">.</span><span class="name attribute">get</span><span class="punctuation">();</span><span class="whitespace"> </span><span class="punctuation">}</span><span class="whitespace"> </span><span class="punctuation">);</span><span class="whitespace">
</span><span class="name">Thread</span><span class="whitespace"> </span><span class="name">p1</span><span class="punctuation">,</span><span class="name">p2</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">Thread</span><span class="punctuation">(()</span><span class="whitespace"> </span><span class="operator">=&gt;</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace"> </span><span class="name">bb</span><span class="punctuation">.</span><span class="name attribute">put</span><span class="punctuation">(</span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">Object</span><span class="punctuation">());</span><span class="whitespace"> </span><span class="punctuation">}</span><span class="whitespace"> </span><span class="punctuation">);</span><span class="whitespace">
</span><span class="name">g1</span><span class="punctuation">.</span><span class="name attribute">start</span><span class="punctuation">();</span><span class="whitespace"> </span><span class="name">g2</span><span class="punctuation">.</span><span class="name attribute">start</span><span class="punctuation">();</span><span class="whitespace"> </span><span class="name">p1</span><span class="punctuation">.</span><span class="name attribute">start</span><span class="punctuation">();</span><span class="whitespace"> </span><span class="name">p2</span><span class="punctuation">.</span><span class="name attribute">start</span><span class="punctuation">();</span></code></pre>
<table>
<thead>
<tr><th class="head"></th>
<th class="head"><p>Aktionen</p></th>
<th class="head"><p>(Änderung des) Zustand(s) des Buffers</p></th>
<th class="head"><p>Auf die Sperre (<em>Lock</em>) wartend</p></th>
<th class="head"><p>An der Bedingung wartend</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>1</p></td>
<td><p><strong>g1:bb.get()</strong> <span class="raw-html"><br></span>
g2:bb.get(), p1:bb.put(), p2:bb.put()</p></td>
<td><p>empty</p></td>
<td><p>{g2,p1,p2}</p></td>
<td><p>{g1}</p></td>
</tr>
<tr><td><p>2</p></td>
<td><p><strong>g2:bb.get()</strong></p></td>
<td><p>empty</p></td>
<td><p>{p1,p2}</p></td>
<td><p>{g1,g2}</p></td>
</tr>
<tr><td><p>3</p></td>
<td><p><strong>p1:bb.put()</strong></p></td>
<td><p>empty → not empty</p></td>
<td><p>{p2,g1}</p></td>
<td><p>{g2}</p></td>
</tr>
<tr><td><p>4</p></td>
<td><p><strong>p2:bb.put()</strong></p></td>
<td><p>not empty</p></td>
<td><p>{g1}</p></td>
<td><p>{g2,p2}</p></td>
</tr>
<tr><td><p>5</p></td>
<td><p><strong>g1:bb.get()</strong></p></td>
<td><p>not empty → empty</p></td>
<td><p>{g2}</p></td>
<td><p>{p2}</p></td>
</tr>
<tr><td><p>6</p></td>
<td><p><strong>g2:bb.get()</strong></p></td>
<td><p>empty</p></td>
<td><p>∅</p></td>
<td><p>{g2,p2}</p></td>
</tr>
</tbody>
</table>
</div></div><div class="supplemental">
<p>In Schritt 5 wurde von der VM - aufgrund des Aufrufs von <span class="docutils literal">notify</span> durch <span class="docutils literal">g1</span> - der Thread <span class="docutils literal">g2</span> aufgeweckt - anstatt des Threads <span class="docutils literal">p2</span>. Der aufgeweckete Thread <span class="docutils literal">g2</span> prüft die Bedingung (Schritt 6) und stellt fest, dass der Buffer leer ist. Er geht wieder in den Wartezustand. Jetzt warten sowohl ein Thread, der ein Wert schreiben möchte als auch ein Thread, der einen Wert lesen möchte.</p>
</div></div><div class="new-section ld-slide" id="fortgeschrittene-synchronisationsmechanismen-primitive-und-konzepte">
<h2>Fortgeschrittene Synchronisationsmechanismen, -primitive und -konzepte.</h2>
</div><div class="ld-slide" id="java-api-fur-nebenlaufige-programmierung">
<h2>Java API für nebenläufige Programmierung</h2>
<dl class="field-list simple">
<dt>java.util.concurrent<span class="colon">:</span></dt>
<dd><p>Bietet verschiedene Klassen zur Unterstützung gängiger nebenläufiger Programmierparadigmen, z. B. Unterstützung für <em>BoundedBuffers</em> oder Thread-Pools.</p>
</dd>
<dt>java.util.concurrent.atomic<span class="colon">:</span></dt>
<dd><p>Bietet Unterstützung für sperrfreie (<em>lock-free</em>), thread-sichere Programmierung auf einfachen Variablen — wie zum Beispiel atomaren Integern — an.</p>
</dd>
<dt>java.util.concurrent.locks<span class="colon">:</span></dt>
<dd><p>Bietet verschiedene Sperralgorithmen an, die die Java-Sprachmechanismen ergänzen, z. B. Schreib-Lese-Sperren und Bedingungsvariablen. Dies ermöglicht zum Beispiel: &quot;Hand-over-Hand&quot; oder &quot;Chain Locking&quot;.</p>
</dd>
</dl>
</div><div class="smaller ld-slide" id="beispiel-bedingte-synchronisation-mit-reentrantlocks">
<h2>Beispiel: Bedingte Synchronisation mit <em>ReentrantLock</em>s.</h2>
<p>Ein <em>BoundedBuffer</em> hat z. B. traditionell zwei Bedingungsvariablen: <em>BufferNotFull</em> und <em>BufferNotEmpty</em>.</p>
<div class="stack tiny">
<div class="layer">
<pre class="code Java smaller literal-block"><code><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">class</span> <span class="name class">BoundedBuffer</span><span class="operator">&lt;</span><span class="name">T</span><span class="operator">&gt;</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">

  </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="name">T</span><span class="whitespace"> </span><span class="name">buffer</span><span class="operator">[]</span><span class="punctuation">;</span><span class="whitespace">
  </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">first</span><span class="punctuation">;</span><span class="whitespace">
  </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">last</span><span class="punctuation">;</span><span class="whitespace">
  </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">numberInBuffer</span><span class="punctuation">;</span><span class="whitespace">
  </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">size</span><span class="punctuation">;</span><span class="whitespace">


  </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="name">Lock</span><span class="whitespace"> </span><span class="name">lock</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">ReentrantLock</span><span class="punctuation">();</span><span class="whitespace">
  </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="name">Condition</span><span class="whitespace"> </span><span class="name">notFull</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">lock</span><span class="punctuation">.</span><span class="name attribute">newCondition</span><span class="punctuation">();</span><span class="whitespace">
  </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="name">Condition</span><span class="whitespace"> </span><span class="name">notEmpty</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">lock</span><span class="punctuation">.</span><span class="name attribute">newCondition</span><span class="punctuation">();</span></code></pre>
</div><div class="layer incremental">
<pre class="code Java smaller literal-block"><code><span class="whitespace">  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="name function">BoundedBuffer</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">length</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace"> </span><span class="comment multiline">/* Normaler Constructor. */</span><span class="whitespace">
    </span><span class="name">size</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">length</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="name">buffer</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">T</span><span class="operator">[]</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">Object</span><span class="operator">[</span><span class="name">size</span><span class="operator">]</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="name">last</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal number integer">0</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="name">first</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal number integer">0</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="name">numberInBuffer</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal number integer">0</span><span class="punctuation">;</span><span class="whitespace">
  </span><span class="punctuation">}</span></code></pre>
</div><div class="layer incremental">
<pre class="code Java smaller literal-block"><code><span class="whitespace">  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword type">void</span><span class="whitespace"> </span><span class="name function">put</span><span class="punctuation">(</span><span class="name">T</span><span class="whitespace"> </span><span class="name">item</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword declaration">throws</span><span class="whitespace"> </span><span class="name">InterruptedException</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="name">lock</span><span class="punctuation">.</span><span class="name attribute">lock</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="keyword">try</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">

      </span><span class="keyword">while</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">numberInBuffer</span><span class="whitespace"> </span><span class="operator">==</span><span class="whitespace"> </span><span class="name">size</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace"> </span><span class="name">notFull</span><span class="punctuation">.</span><span class="name attribute">await</span><span class="punctuation">();</span><span class="whitespace"> </span><span class="punctuation">}</span><span class="whitespace">
      </span><span class="name">last</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">last</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal number integer">1</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="operator">%</span><span class="whitespace"> </span><span class="name">size</span><span class="punctuation">;</span><span class="whitespace">
      </span><span class="name">numberInBuffer</span><span class="operator">++</span><span class="punctuation">;</span><span class="whitespace">
      </span><span class="name">buffer</span><span class="operator">[</span><span class="name">last</span><span class="operator">]</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">item</span><span class="punctuation">;</span><span class="whitespace">
      </span><span class="name">notEmpty</span><span class="punctuation">.</span><span class="name attribute">signal</span><span class="punctuation">();</span><span class="whitespace">

    </span><span class="punctuation">}</span><span class="whitespace"> </span><span class="keyword">finally</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
      </span><span class="name">lock</span><span class="punctuation">.</span><span class="name attribute">unlock</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace">
  </span><span class="punctuation">}</span></code></pre>
</div><div class="layer incremental">
<pre class="code Java smaller literal-block"><code><span class="whitespace">  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="name">T</span><span class="whitespace"> </span><span class="name function">get</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="punctuation">...</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="name">lock</span><span class="punctuation">.</span><span class="name attribute">lock</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="keyword">try</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">

      </span><span class="keyword">while</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">numberInBuffer</span><span class="whitespace"> </span><span class="operator">==</span><span class="whitespace"> </span><span class="literal number integer">0</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace"> </span><span class="name">notEmpty</span><span class="punctuation">.</span><span class="name attribute">await</span><span class="punctuation">();</span><span class="whitespace"> </span><span class="punctuation">}</span><span class="whitespace">
      </span><span class="name">first</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">first</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal number integer">1</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="operator">%</span><span class="whitespace"> </span><span class="name">size</span><span class="punctuation">;</span><span class="whitespace">
      </span><span class="name">numberInBuffer</span><span class="operator">--</span><span class="punctuation">;</span><span class="whitespace">
      </span><span class="name">notFull</span><span class="punctuation">.</span><span class="name attribute">signal</span><span class="punctuation">();</span><span class="whitespace">
      </span><span class="keyword">return</span><span class="whitespace"> </span><span class="name">buffer</span><span class="operator">[</span><span class="name">first</span><span class="operator">]</span><span class="punctuation">;</span><span class="whitespace">

    </span><span class="punctuation">}</span><span class="whitespace"> </span><span class="keyword">finally</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
      </span><span class="name">lock</span><span class="punctuation">.</span><span class="name attribute">unlock</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace">
  </span><span class="punctuation">}</span><span class="whitespace">
</span><span class="punctuation">}</span></code></pre>
</div></div></div><div class="ld-slide" id="thread-prioritaten">
<h2>Thread Prioritäten</h2>
<ul class="incremental simple">
<li><p>Obwohl den Java-Threads Prioritäten zugewiesen werden können (<span class="docutils literal">setPriority</span>), dienen sie dem zugrunde liegenden Scheduler nur als Richtschnur für die Ressourcenzuweisung.</p></li>
<li><p>Sobald eine Thread läuft, kann er die Prozessorressourcen explizit aufgeben, indem er die <span class="docutils literal">yield</span>-Methode aufruft.</p></li>
<li><p><span class="docutils literal">yield</span> setzt den Thread an das Ende der Warteschlange für seine Prioritätsstufe.</p></li>
<li><p>Die Scheduling- und Prioritätsmodelle von Java sind jedoch schwach:</p>
<ul>
<li><p>Es gibt keine Garantie dafür, dass immer der Thread mit der höchsten Priorität ausgeführt wird, der lauffähig ist.</p></li>
<li><p>Threads mit gleicher Priorität können in Zeitscheiben unterteilt sein oder auch nicht.</p></li>
<li><p>Bei der Verwendung nativer Threads können unterschiedliche Java-Prioritäten auf dieselbe Betriebssystempriorität abgebildet werden.</p></li>
</ul>
</li>
</ul>
</div><div class="ld-slide" id="best-practices">
<h2>Best Practices</h2>
<ul class="impressive incremental simple">
<li><p><span class="docutils literal">synchronized</span> Code sollte so kurz wie möglich gehalten werden.</p></li>
<li><p>Verschachtelte Monitoraufrufe sollten vermieden werden, da die äußere Sperre nicht freigegeben wird, wenn der innere Monitor wartet. Dies kann leicht zum Auftreten eines Deadlocks führen.</p></li>
</ul>
</div><div class="no-title center-child-elements ld-slide" id="ressourcen-immer-in-der-gleichen-reihenfolge-sperren">
<h2>Ressourcen immer in der gleichen Reihenfolge sperren</h2>
<ul class="impressive simple">
<li><p>Wenn zwei (oder mehr) Threads auf die gleichen Ressourcen in unterschiedlicher Reihenfolge zugreifen, kann es zu einem Deadlock kommen.</p></li>
</ul>
<aside class="admonition warning incremental">
<p class="admonition-title">Zu Beachten</p>
<p><strong>Ressourcen immer in der gleichen Reihenfolge sperren</strong>, um Deadlocks zu vermeiden.</p>
</aside>
</div><div class="new-section ld-slide" id="thread-safety">
<h2>Thread Safety</h2>
<div class="footer-left tiny minor docutils container">
<p><span class="ger">Threadsicherheit</span></p>
</div>
</div><div class="smaller ld-slide" id="thread-safety-voraussetzung">
<h2>Thread Safety - Voraussetzung</h2>
<p>Damit eine Klasse thread-sicher ist, muss sie sich in einer single-threaded Umgebung korrekt verhalten.</p>
<div class="stack smaller">
<div class="layer">
<p>D. h. wenn eine Klasse korrekt implementiert ist, dann sollte keine Abfolge von Operationen (Lesen oder Schreiben von öffentlichen Feldern und Aufrufen von öffentlichen Methoden) auf Objekten dieser Klasse in der Lage sein:</p>
<blockquote>
<ul class="simple">
<li><p>das Objekt in einen ungültigen Zustand versetzen,</p></li>
<li><p>das Objekt in einem ungültigen Zustand zu beobachten oder</p></li>
<li><p>eine der Invarianten, Vorbedingungen oder Nachbedingungen der Klasse verletzen.</p></li>
</ul>
</blockquote>
</div><div class="layer incremental">
<p>Die Klasse muss das korrekte Verhalten auch dann aufweisen,
wenn auf sie von mehreren Threads aus zugegriffen wird.</p>
<ul class="simple">
<li><p>Unabhängig vom <em>Scheduling</em> oder der Verschachtelung der Ausführung dieser Threads durch die Laufzeitumgebung,</p></li>
<li><p>Ohne zusätzliche Synchronisierung auf Seiten des aufrufenden Codes.</p></li>
</ul>
</div></div><div class="incremental rounded-corners dhbw-light-gray-background padding-1em margin-top-1em smaller docutils container">
<p>Dies hat zur Folge, dass Operationen auf einem thread-sicheren Objekt für alle Threads so erscheinen als ob die Operationen in einer festen, global konsistenten Reihenfolge erfolgen würden.</p>
</div>
</div><div class="smaller ld-slide" id="thread-safety-level">
<h2>Thread Safety Level</h2>
<dl class="field-list simple">
<dt>Immutable <span class="ger">Unveränderlich</span><span class="colon">:</span></dt>
<dd><p>die Objekt sind konstant und können nicht geändert werden.</p>
</dd>
<dt>Thread-sicher<span class="colon">:</span></dt>
<dd><p>Die Objekte sind veränderbar, unterstützen aber nebenläufigen Zugriff, da die Methoden entsprechend synchronisiert sind.</p>
</dd>
<dt>Bedingt Thread-sicher<span class="colon">:</span></dt>
<dd><p>Objekte bei denen jede einzelne Operation thread-sicher ist, aber bestimmte Sequenzen von Operationen eine externe Synchronisierung erfordern können.</p>
</dd>
<dt>Thread-kompatibel<span class="colon">:</span></dt>
<dd><p>Objekte die keinerlei Synchronisierung aufweisen. Der Aufrufer kann die Synchronisierung jedoch ggf. extern übernehmen.</p>
</dd>
<dt>Thread-hostile <span class="ger-quote">Thread-schädlich</span><span class="colon">:</span></dt>
<dd><p>Objekte, die nicht thread-sicher sind und auch nicht thread-sicher gemacht werden können, da sie zum Beispiel globalen Zustand manipulieren.</p>
</dd>
</dl>
</div><div class="integrated-exercise ld-slide" id="ubung-thread-sichere-programmierung">
<h2>Übung: <em>Thread-sichere Programmierung</em></h2>
<div class="tiny docutils container">
<p>Implementieren Sie eine Klasse <span class="docutils literal">ThreadsafeArray</span> zum Speichern von nicht-<span class="docutils literal">null</span> Objekten (<span class="docutils literal">java.lang.Object</span>) an ausgewählten Indizes — vergleichbar mit einem normalen Array. Im Vergleich zu einem normalen Array sollen die Aufrufer jedoch ggf. blockiert werden, wenn der Zustand des Arrays nicht den Anforderungen des Aufrufers genügt. Die Klasse soll folgende Methoden bereitstellen:</p>
<dl class="field-list simple">
<dt><span class="docutils literal">get(int index)</span><span class="colon">:</span></dt>
<dd><p>Liefert den Wert an der Position <span class="docutils literal">index</span> zurück. Der aufrufende Thread wird ggf. blockiert, bis ein Wert an der Position <span class="docutils literal">index</span> gespeichert wurde. (Die <span class="docutils literal">get</span>-Methode entfernt den Wert nicht aus dem Array.)</p>
</dd>
<dt><span class="docutils literal">set(int index, Object value)</span><span class="colon">:</span></dt>
<dd><p>Speichert den Wert <span class="docutils literal">value</span> an der Position <span class="docutils literal">index</span>. Falls an der Position <span class="docutils literal">index</span> bereits ein Wert gespeichert wurde, wird der aufrufende Thread blockiert, bis der Wert an der Position <span class="docutils literal">index</span> gelöscht wurde.</p>
</dd>
<dt><span class="docutils literal">delete(int index)</span><span class="colon">:</span></dt>
<dd><p>Löscht ggf. den Wert an der Position <span class="docutils literal">index</span> wenn ein Wert vorhanden ist. Andernfalls wird der Thread blockiert bis es einen Wert gibt, der gelöscht werden kann.</p>
</dd>
</dl>
<ol class="loweralpha simple">
<li><p>Implementieren Sie die Klasse <span class="docutils literal">ThreadsafeArray</span> nur unter Verwendung der Standardprimitive: <span class="docutils literal">synchronized</span>, <span class="docutils literal">wait</span>, <span class="docutils literal">notify</span> und <span class="docutils literal">notifyAll</span>. Nutzen Sie die Vorlage.</p></li>
<li><p>Können Sie sowohl <span class="docutils literal">notify</span> als auch <span class="docutils literal">notifyAll</span> verwenden?</p></li>
<li><p>Implementieren Sie die Klasse <span class="docutils literal">ThreadsafeArray</span> unter Verwendung von <span class="docutils literal">ReentrantLock</span>s und <span class="docutils literal">Condition</span>s. Nutzen Sie die Vorlage.</p></li>
<li><p>Welche Vorteile hat die Verwendung von <span class="docutils literal">ReentrantLock</span>s?</p></li>
</ol>
</div>
<div class="supplemental tiny">
<p>Sie können sich die Klasse <span class="docutils literal">ThreadsafeArray</span> auch als ein Array von BoundedBuffers mit der Größe 1 vorstellen.</p>
<pre class="code Java smaller literal-block"><code><span class="whitespace">  </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">class</span> <span class="name class">ThreadsafeArray</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">

    </span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="name">Object</span><span class="operator">[]</span><span class="whitespace"> </span><span class="name">array</span><span class="punctuation">;</span><span class="whitespace">

    </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="name function">ThreadsafeArray</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">size</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
        </span><span class="keyword">this</span><span class="punctuation">.</span><span class="name attribute">array</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">Object</span><span class="operator">[</span><span class="name">size</span><span class="operator">]</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace">

    </span><span class="comment single">// Methodensignaturen ggf. vervollständigen</span><span class="whitespace">
    </span><span class="comment single">// und Implementierungen ergänzen</span><span class="whitespace">
    </span><span class="name">Object</span><span class="whitespace"> </span><span class="name function">get</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">index</span><span class="punctuation">)</span><span class="whitespace">
    </span><span class="keyword type">void</span><span class="whitespace"> </span><span class="name function">set</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">index</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="name">Object</span><span class="whitespace"> </span><span class="name">value</span><span class="punctuation">)</span><span class="whitespace">
    </span><span class="keyword type">void</span><span class="whitespace"> </span><span class="name function">remove</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">index</span><span class="punctuation">)</span><span class="whitespace">

    </span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">static</span><span class="whitespace"> </span><span class="keyword type">void</span><span class="whitespace"> </span><span class="name function">main</span><span class="punctuation">(</span><span class="name">String</span><span class="operator">[]</span><span class="whitespace"> </span><span class="name">args</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword declaration">throws</span><span class="whitespace"> </span><span class="name">Exception</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
      </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">ARRAY_SIZE</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal number integer">2</span><span class="punctuation">;</span><span class="whitespace">
      </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">SLEEP_TIME</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal number integer">1</span><span class="punctuation">;</span><span class="whitespace"> </span><span class="comment single">// ms</span><span class="whitespace">
      </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">array</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">ThreadsafeArray</span><span class="punctuation">(</span><span class="name">ARRAY_SIZE</span><span class="punctuation">);</span><span class="whitespace">
      </span><span class="keyword">for</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">i</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal number integer">0</span><span class="punctuation">;</span><span class="whitespace"> </span><span class="name">i</span><span class="whitespace"> </span><span class="operator">&lt;</span><span class="whitespace"> </span><span class="name">ARRAY_SIZE</span><span class="punctuation">;</span><span class="whitespace"> </span><span class="name">i</span><span class="operator">++</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
        </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">threadId</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">i</span><span class="punctuation">;</span><span class="whitespace">

        </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">readerThreadName</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal string">&quot;Reader&quot;</span><span class="punctuation">;</span><span class="whitespace">
        </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">t2</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">Thread</span><span class="punctuation">(()</span><span class="whitespace"> </span><span class="operator">-&gt;</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
          </span><span class="keyword">while</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="keyword constant">true</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
            </span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">j</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="keyword type">int</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">Math</span><span class="punctuation">.</span><span class="name attribute">random</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="operator">*</span><span class="whitespace"> </span><span class="name">ARRAY_SIZE</span><span class="punctuation">);</span><span class="whitespace">
            </span><span class="keyword">try</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
                </span><span class="name">out</span><span class="punctuation">.</span><span class="name attribute">println</span><span class="punctuation">(</span><span class="name">readerThreadName</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot;[&quot;</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="name">j</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot;]&quot;</span><span class="whitespace"> </span><span class="punctuation">);</span><span class="whitespace">
                </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">o</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">array</span><span class="punctuation">.</span><span class="name attribute">get</span><span class="punctuation">(</span><span class="name">j</span><span class="punctuation">);</span><span class="whitespace">
                </span><span class="name">out</span><span class="punctuation">.</span><span class="name attribute">println</span><span class="punctuation">(</span><span class="name">readerThreadName</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace">
                    </span><span class="literal string">&quot;[&quot;</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="name">j</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot;] ⇒ #&quot;</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="name">o</span><span class="punctuation">.</span><span class="name attribute">hashCode</span><span class="punctuation">());</span><span class="whitespace">
                </span><span class="name">Thread</span><span class="punctuation">.</span><span class="name attribute">sleep</span><span class="punctuation">(</span><span class="name">SLEEP_TIME</span><span class="punctuation">);</span><span class="whitespace">
            </span><span class="punctuation">}</span><span class="whitespace"> </span><span class="keyword">catch</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">InterruptedException</span><span class="whitespace"> </span><span class="name">e</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
                </span><span class="name">e</span><span class="punctuation">.</span><span class="name attribute">printStackTrace</span><span class="punctuation">();</span><span class="whitespace">
            </span><span class="punctuation">}</span><span class="whitespace">
          </span><span class="punctuation">}</span><span class="whitespace">
        </span><span class="punctuation">},</span><span class="whitespace"> </span><span class="name">readerThreadName</span><span class="punctuation">);</span><span class="whitespace">
        </span><span class="name">t2</span><span class="punctuation">.</span><span class="name attribute">start</span><span class="punctuation">();</span><span class="whitespace">

        </span><span class="comment single">// One Thread for each slot that will eventually</span><span class="whitespace">
        </span><span class="comment single">// write some content</span><span class="whitespace">
        </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">writerThreadName</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal string">&quot;Writer[&quot;</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="name">threadId</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot;]&quot;</span><span class="punctuation">;</span><span class="whitespace">
        </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">t1</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">Thread</span><span class="punctuation">(()</span><span class="whitespace"> </span><span class="operator">-&gt;</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
          </span><span class="keyword">while</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="keyword constant">true</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
            </span><span class="keyword">try</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
                </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">o</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">Object</span><span class="punctuation">();</span><span class="whitespace">
                </span><span class="name">out</span><span class="punctuation">.</span><span class="name attribute">println</span><span class="punctuation">(</span><span class="name">writerThreadName</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot; = #&quot;</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="name">o</span><span class="punctuation">.</span><span class="name attribute">hashCode</span><span class="punctuation">());</span><span class="whitespace">
                </span><span class="name">array</span><span class="punctuation">.</span><span class="name attribute">set</span><span class="punctuation">(</span><span class="name">threadId</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="name">o</span><span class="punctuation">);</span><span class="whitespace">
                </span><span class="name">out</span><span class="punctuation">.</span><span class="name attribute">println</span><span class="punctuation">(</span><span class="name">writerThreadName</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot; done&quot;</span><span class="punctuation">);</span><span class="whitespace">
                </span><span class="name">Thread</span><span class="punctuation">.</span><span class="name attribute">sleep</span><span class="punctuation">(</span><span class="name">SLEEP_TIME</span><span class="punctuation">);</span><span class="whitespace">
            </span><span class="punctuation">}</span><span class="whitespace"> </span><span class="keyword">catch</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">InterruptedException</span><span class="whitespace"> </span><span class="name">e</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
                </span><span class="name">e</span><span class="punctuation">.</span><span class="name attribute">printStackTrace</span><span class="punctuation">();</span><span class="whitespace">
            </span><span class="punctuation">}</span><span class="whitespace">
          </span><span class="punctuation">}</span><span class="whitespace">
        </span><span class="punctuation">},</span><span class="whitespace"> </span><span class="name">writerThreadName</span><span class="punctuation">);</span><span class="whitespace">
        </span><span class="name">t1</span><span class="punctuation">.</span><span class="name attribute">start</span><span class="punctuation">();</span><span class="whitespace">

        </span><span class="comment single">// One Thread for each slot that will eventually</span><span class="whitespace">
        </span><span class="comment single">// delete the content</span><span class="whitespace">
        </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">deleterThreadName</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal string">&quot;Delete[&quot;</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="name">threadId</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot;]&quot;</span><span class="punctuation">;</span><span class="whitespace">
        </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">t3</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">Thread</span><span class="punctuation">(()</span><span class="whitespace"> </span><span class="operator">-&gt;</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
          </span><span class="keyword">while</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="keyword constant">true</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
            </span><span class="keyword">try</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
                </span><span class="name">out</span><span class="punctuation">.</span><span class="name attribute">println</span><span class="punctuation">(</span><span class="name">deleterThreadName</span><span class="punctuation">);</span><span class="whitespace">
                </span><span class="name">array</span><span class="punctuation">.</span><span class="name attribute">delete</span><span class="punctuation">(</span><span class="name">threadId</span><span class="punctuation">);</span><span class="whitespace">
                </span><span class="name">Thread</span><span class="punctuation">.</span><span class="name attribute">sleep</span><span class="punctuation">(</span><span class="name">SLEEP_TIME</span><span class="punctuation">);</span><span class="whitespace">
            </span><span class="punctuation">}</span><span class="whitespace"> </span><span class="keyword">catch</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">InterruptedException</span><span class="whitespace"> </span><span class="name">e</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
                </span><span class="name">e</span><span class="punctuation">.</span><span class="name attribute">printStackTrace</span><span class="punctuation">();</span><span class="whitespace">
            </span><span class="punctuation">}</span><span class="whitespace">
          </span><span class="punctuation">}</span><span class="whitespace">
        </span><span class="punctuation">},</span><span class="whitespace"> </span><span class="name">deleterThreadName</span><span class="punctuation">);</span><span class="whitespace">
        </span><span class="name">t3</span><span class="punctuation">.</span><span class="name attribute">start</span><span class="punctuation">();</span><span class="whitespace">
      </span><span class="punctuation">}</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace">
  </span><span class="punctuation">}</span></code></pre>
</div><div class="protected-exercise-solution">
<p class="rubric">ThreadSafeArray mit Standardprimitiven</p>
<ol class="loweralpha">
<li><pre class="code Java literal-block"><code><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">synchronized</span><span class="whitespace"> </span><span class="name">Object</span><span class="whitespace"> </span><span class="name function">get</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">index</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword declaration">throws</span><span class="whitespace"> </span><span class="name">InterruptedException</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">v</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">array</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="keyword">while</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">v</span><span class="whitespace"> </span><span class="operator">==</span><span class="whitespace"> </span><span class="keyword constant">null</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
        </span><span class="name">out</span><span class="punctuation">.</span><span class="name attribute">println</span><span class="punctuation">(</span><span class="name">Thread</span><span class="punctuation">.</span><span class="name attribute">currentThread</span><span class="punctuation">().</span><span class="name attribute">getName</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot; will go to sleep&quot;</span><span class="punctuation">);</span><span class="whitespace">
        </span><span class="name">wait</span><span class="punctuation">();</span><span class="whitespace">
        </span><span class="name">v</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">array</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace">
    </span><span class="keyword">return</span><span class="whitespace"> </span><span class="name">v</span><span class="punctuation">;</span><span class="whitespace">
</span><span class="punctuation">}</span><span class="whitespace">

</span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">synchronized</span><span class="whitespace"> </span><span class="keyword type">void</span><span class="whitespace"> </span><span class="name function">set</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">index</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="name">Object</span><span class="whitespace"> </span><span class="name">value</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword declaration">throws</span><span class="whitespace"> </span><span class="name">InterruptedException</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="keyword">while</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">array</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="whitespace"> </span><span class="operator">!=</span><span class="whitespace"> </span><span class="keyword constant">null</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
        </span><span class="name">out</span><span class="punctuation">.</span><span class="name attribute">println</span><span class="punctuation">(</span><span class="name">Thread</span><span class="punctuation">.</span><span class="name attribute">currentThread</span><span class="punctuation">().</span><span class="name attribute">getName</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot; will go to sleep&quot;</span><span class="punctuation">);</span><span class="whitespace">
        </span><span class="name">wait</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace">
    </span><span class="name">array</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">value</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="name">notifyAll</span><span class="punctuation">();</span><span class="whitespace">
</span><span class="punctuation">}</span><span class="whitespace">

</span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword declaration">synchronized</span><span class="whitespace"> </span><span class="keyword type">void</span><span class="whitespace"> </span><span class="name function">delete</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">index</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword declaration">throws</span><span class="whitespace"> </span><span class="name">InterruptedException</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="keyword">while</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">array</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="whitespace"> </span><span class="operator">==</span><span class="whitespace"> </span><span class="keyword constant">null</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
        </span><span class="name">out</span><span class="punctuation">.</span><span class="name attribute">println</span><span class="punctuation">(</span><span class="name">Thread</span><span class="punctuation">.</span><span class="name attribute">currentThread</span><span class="punctuation">().</span><span class="name attribute">getName</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot; will go to sleep&quot;</span><span class="punctuation">);</span><span class="whitespace">
        </span><span class="name">wait</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace">
    </span><span class="name">array</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword constant">null</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="name">notifyAll</span><span class="punctuation">();</span><span class="whitespace">
</span><span class="punctuation">}</span></code></pre>
</li>
<li><p><span class="docutils literal">notify</span> kann nicht verwendet werden, da wir unterschiedliche Bedingungen haben und es bei der Verwendung von <span class="docutils literal">notify</span> somit zum Aufwecken eines ungeeigneten Threads kommen könnte. Dies könnte dazu führen könnte, dass alle Threads im Wartezustand sind obwohl Fortschritt möglich wäre.</p></li>
<li><pre class="code Java literal-block"><code><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="name">Object</span><span class="operator">[]</span><span class="whitespace"> </span><span class="name">array</span><span class="punctuation">;</span><span class="whitespace">
</span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="name">ReentrantLock</span><span class="operator">[]</span><span class="whitespace"> </span><span class="name">locks</span><span class="punctuation">;</span><span class="whitespace">
</span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="name">Condition</span><span class="operator">[]</span><span class="whitespace"> </span><span class="name">notEmptyConditions</span><span class="punctuation">;</span><span class="whitespace">
</span><span class="keyword declaration">private</span><span class="whitespace"> </span><span class="keyword declaration">final</span><span class="whitespace"> </span><span class="name">Condition</span><span class="operator">[]</span><span class="whitespace"> </span><span class="name">notFullConditions</span><span class="punctuation">;</span><span class="whitespace">

</span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="name function">ThreadsafeArrayWithConditionVariables</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">size</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="keyword">this</span><span class="punctuation">.</span><span class="name attribute">array</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">Object</span><span class="operator">[</span><span class="name">size</span><span class="operator">]</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="keyword">this</span><span class="punctuation">.</span><span class="name attribute">locks</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">ReentrantLock</span><span class="operator">[</span><span class="name">size</span><span class="operator">]</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="keyword">this</span><span class="punctuation">.</span><span class="name attribute">notEmptyConditions</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">Condition</span><span class="operator">[</span><span class="name">size</span><span class="operator">]</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="keyword">this</span><span class="punctuation">.</span><span class="name attribute">notFullConditions</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">Condition</span><span class="operator">[</span><span class="name">size</span><span class="operator">]</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="keyword">for</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">i</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="literal number integer">0</span><span class="punctuation">;</span><span class="whitespace"> </span><span class="name">i</span><span class="whitespace"> </span><span class="operator">&lt;</span><span class="whitespace"> </span><span class="name">size</span><span class="punctuation">;</span><span class="whitespace"> </span><span class="name">i</span><span class="operator">++</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
        </span><span class="name">locks</span><span class="operator">[</span><span class="name">i</span><span class="operator">]</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword">new</span><span class="whitespace"> </span><span class="name">ReentrantLock</span><span class="punctuation">(</span><span class="keyword constant">true</span><span class="punctuation">);</span><span class="whitespace">
        </span><span class="name">notEmptyConditions</span><span class="operator">[</span><span class="name">i</span><span class="operator">]</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">locks</span><span class="operator">[</span><span class="name">i</span><span class="operator">]</span><span class="punctuation">.</span><span class="name attribute">newCondition</span><span class="punctuation">();</span><span class="whitespace">
        </span><span class="name">notFullConditions</span><span class="operator">[</span><span class="name">i</span><span class="operator">]</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">locks</span><span class="operator">[</span><span class="name">i</span><span class="operator">]</span><span class="punctuation">.</span><span class="name attribute">newCondition</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace">
</span><span class="punctuation">}</span><span class="whitespace">

</span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="name">Object</span><span class="whitespace"> </span><span class="name function">get</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">index</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword declaration">throws</span><span class="whitespace"> </span><span class="name">InterruptedException</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="name">locks</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="punctuation">.</span><span class="name attribute">lock</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="keyword">try</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
        </span><span class="keyword declaration">var</span><span class="whitespace"> </span><span class="name">v</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">array</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="punctuation">;</span><span class="whitespace">
        </span><span class="keyword">while</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">v</span><span class="whitespace"> </span><span class="operator">==</span><span class="whitespace"> </span><span class="keyword constant">null</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
            </span><span class="name">out</span><span class="punctuation">.</span><span class="name attribute">println</span><span class="punctuation">(</span><span class="name">Thread</span><span class="punctuation">.</span><span class="name attribute">currentThread</span><span class="punctuation">().</span><span class="name attribute">getName</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot; will go to sleep&quot;</span><span class="punctuation">);</span><span class="whitespace">
            </span><span class="name">notEmptyConditions</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="punctuation">.</span><span class="name attribute">await</span><span class="punctuation">();</span><span class="whitespace">
            </span><span class="name">out</span><span class="punctuation">.</span><span class="name attribute">println</span><span class="punctuation">(</span><span class="name">Thread</span><span class="punctuation">.</span><span class="name attribute">currentThread</span><span class="punctuation">().</span><span class="name attribute">getName</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot; awakened&quot;</span><span class="punctuation">);</span><span class="whitespace">
            </span><span class="name">v</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">array</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="punctuation">;</span><span class="whitespace">
        </span><span class="punctuation">}</span><span class="whitespace">
        </span><span class="keyword">return</span><span class="whitespace"> </span><span class="name">v</span><span class="punctuation">;</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace"> </span><span class="keyword">finally</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
        </span><span class="name">locks</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="punctuation">.</span><span class="name attribute">unlock</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace">
</span><span class="punctuation">}</span><span class="whitespace">

</span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword type">void</span><span class="whitespace"> </span><span class="name function">set</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">index</span><span class="punctuation">,</span><span class="whitespace"> </span><span class="name">Object</span><span class="whitespace"> </span><span class="name">value</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword declaration">throws</span><span class="whitespace"> </span><span class="name">InterruptedException</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="name">locks</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="punctuation">.</span><span class="name attribute">lock</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="keyword">try</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
        </span><span class="keyword">while</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">array</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="whitespace"> </span><span class="operator">!=</span><span class="whitespace"> </span><span class="keyword constant">null</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
            </span><span class="name">out</span><span class="punctuation">.</span><span class="name attribute">println</span><span class="punctuation">(</span><span class="name">Thread</span><span class="punctuation">.</span><span class="name attribute">currentThread</span><span class="punctuation">().</span><span class="name attribute">getName</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot; will go to sleep&quot;</span><span class="punctuation">);</span><span class="whitespace">
            </span><span class="name">notFullConditions</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="punctuation">.</span><span class="name attribute">await</span><span class="punctuation">();</span><span class="whitespace">
            </span><span class="name">out</span><span class="punctuation">.</span><span class="name attribute">println</span><span class="punctuation">(</span><span class="name">Thread</span><span class="punctuation">.</span><span class="name attribute">currentThread</span><span class="punctuation">().</span><span class="name attribute">getName</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot; awakened&quot;</span><span class="punctuation">);</span><span class="whitespace">
        </span><span class="punctuation">}</span><span class="whitespace">
        </span><span class="name">array</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="name">value</span><span class="punctuation">;</span><span class="whitespace">
        </span><span class="name">notEmptyConditions</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="punctuation">.</span><span class="name attribute">signalAll</span><span class="punctuation">();</span><span class="whitespace"> </span><span class="comment single">// otherwise, it may happen that we &quot;just&quot; wake up a getter thread...</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace"> </span><span class="keyword">finally</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
        </span><span class="name">locks</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="punctuation">.</span><span class="name attribute">unlock</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace">
</span><span class="punctuation">}</span><span class="whitespace">

</span><span class="keyword declaration">public</span><span class="whitespace"> </span><span class="keyword type">void</span><span class="whitespace"> </span><span class="name function">delete</span><span class="punctuation">(</span><span class="keyword type">int</span><span class="whitespace"> </span><span class="name">index</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="keyword declaration">throws</span><span class="whitespace"> </span><span class="name">InterruptedException</span><span class="punctuation">{</span><span class="whitespace">
    </span><span class="name">locks</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="punctuation">.</span><span class="name attribute">lock</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="keyword">try</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
        </span><span class="keyword">while</span><span class="whitespace"> </span><span class="punctuation">(</span><span class="name">array</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="whitespace"> </span><span class="operator">==</span><span class="whitespace"> </span><span class="keyword constant">null</span><span class="punctuation">)</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
            </span><span class="name">out</span><span class="punctuation">.</span><span class="name attribute">println</span><span class="punctuation">(</span><span class="name">Thread</span><span class="punctuation">.</span><span class="name attribute">currentThread</span><span class="punctuation">().</span><span class="name attribute">getName</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot; will go to sleep&quot;</span><span class="punctuation">);</span><span class="whitespace">
            </span><span class="name">notEmptyConditions</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="punctuation">.</span><span class="name attribute">await</span><span class="punctuation">();</span><span class="whitespace">
            </span><span class="name">out</span><span class="punctuation">.</span><span class="name attribute">println</span><span class="punctuation">(</span><span class="name">Thread</span><span class="punctuation">.</span><span class="name attribute">currentThread</span><span class="punctuation">().</span><span class="name attribute">getName</span><span class="punctuation">()</span><span class="whitespace"> </span><span class="operator">+</span><span class="whitespace"> </span><span class="literal string">&quot; awakened&quot;</span><span class="punctuation">);</span><span class="whitespace">
        </span><span class="punctuation">}</span><span class="whitespace">
        </span><span class="name">array</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="whitespace"> </span><span class="operator">=</span><span class="whitespace"> </span><span class="keyword constant">null</span><span class="punctuation">;</span><span class="whitespace">
        </span><span class="name">notFullConditions</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="punctuation">.</span><span class="name attribute">signal</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace"> </span><span class="keyword">finally</span><span class="whitespace"> </span><span class="punctuation">{</span><span class="whitespace">
        </span><span class="name">locks</span><span class="operator">[</span><span class="name">index</span><span class="operator">]</span><span class="punctuation">.</span><span class="name attribute">unlock</span><span class="punctuation">();</span><span class="whitespace">
    </span><span class="punctuation">}</span><span class="whitespace">
</span><span class="punctuation">}</span></code></pre>
</li>
<li><p>Wir können zumindest für die Bedingung <em>notFull</em> <span class="docutils literal">signal</span> verwenden, da auf der Bedingungsvariable <em>notFull</em> ggf. nur die <span class="docutils literal">set</span>-Methode wartet. Für die Bedigung <em>notEmpty</em> können wir jedoch nur <span class="docutils literal">signalAll</span> verwenden, da auf der Bedingungsvariable <em>notEmpty</em> sowohl die <span class="docutils literal">get</span>- als auch die <span class="docutils literal">delete</span>-Methode warten können und es sonst passieren können, dass nach einem <span class="docutils literal">set</span> Aufruf kein <span class="docutils literal">delete</span> aufgeweckt wird.</p></li>
</ol>
</div></div>
</body>
</html>
